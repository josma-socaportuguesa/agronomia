<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link href='https://fonts.googleapis.com/css?family=Open+Sans|Oswald' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="css/cuerpo.css">
	<link rel="stylesheet" type="text/css" href="css/menu.css">
	<link rel="stylesheet" type="text/css" href="css/formulario.css">
</head>
<body>
	<div contenedor>
		
	</div>
</body>
<script type="text/javascript" src='js/constructor.js'></script>
<script type="text/javascript" src='js/motorRegistros.js'></script>
<script type="text/javascript">
	//objeto propio del formulario
	/*------------------------------Objeto VentanaForm------------*/
	var VentanaForm = function(){

		this.tipo = 'noPosee';

		this.nodo;

		this.estado = 'sinConstruir';

		//este es usado cuando se va a editar un registro en especifico
		this.registroId='';

		this.construirNodo = function(data){
			var nodo = document.createElement('div');
			nodo.setAttribute('capaForm','');
			nodo.id='VentanaForm';
			this.tipo=data.tipo;
			this.nodo=nodo;
			if(data.tipo=='modificar'){
				this.registroId=data.id;
			}else if(data.tipo=='nuevo'){
				this.registroId='';
			}
			this.reconstruirInterfaz();
		}
		this.reconstruirInterfaz=function(){
			var html='';
			if(this.tipo=='nuevo'){
				this.registroId='';
				interfaz.elementos.formulario.controlLista();
				this.nodo.style.height='0px';		
				setTimeout(function(){
					var nodo=interfaz.elementos.formulario.ventanaForm.nodo;
					nodo.style.height='250px';
					html+='\
					<section titulo>Nuevo Rol</section>\
						<section sector>\
							<form name ="formNuevo">\
								<div class="group">\
							      <input type="text" name="Nombre" required>\
							      <span class="highlight"></span>\
							      <span class="bar"></span>\
							      <label>Nombre</label>\
							    </div>\
							    <div class="group">\
							      <input type="text" name="Descripcion" required>\
							      <span class="highlight"></span>\
							      <span class="bar"></span>\
							      <label>Descripcion</label>\
							    </div>\
							</form>\
						</section>\
					</section>';
					nodo.innerHTML=html;
				},600);
				interfaz.elementos.botonera.agregarBoton('guardar');
			}else if(this.tipo='modificar'){
				var data = torque.buscarRegistro(this.registroId,torque.entidadActiva);
				interfaz.elementos.botonera.quitarBoton('guardar');
				this.nodo.style.height='0px';		
				setTimeout(function(){
					var nodo=interfaz.elementos.formulario.ventanaForm.nodo;
					nodo.style.height='250px';
					nodo.style.borderRadius='0px';
						html+='\
					<section titulo><textarea  name="nombre"></textarea><span>'+data.nombre+'</span><article update="campo"></article></section>\
						<section sector>\
							<div><textarea name="descripcion"></textarea><span >'+data.descripcion+'</span><article update="area"></article></div>\
						</section>\
						<section sector>\
							<div>Empresas</div>\
							<section contenedor id="contenedorPri">\
							</section>\
						</section>\
					</section>';
					nodo.innerHTML=html;
					normalizarNodo(nodo);
					normalizarNodo(nodo.childNodes[2]);
					var contenedor=nodo.childNodes[2].childNodes[1];
					this.nodo=nodo;
					//arreglo temporal de empresas
						dataTemp=torque.buscarDetalle(data.id,'rol');
						interfaz.elementos.formulario.ventanaForm.agregarEmpresas(contenedor,dataTemp);
				},600);
			}
		};
		this.destruirNodo = function(){
			if(this.registroId!=''){
				this.registroId='';
				interfaz.elementos.formulario.controlLista();
			}
			this.nodo.style.height='0px';
			setTimeout(function(){
				var vf=interfaz.elementos.formulario.ventanaForm;
				vf.nodo.parentNode.removeChild(vf.nodo);
				vf.estado='sinConstruir';
			},510);
		};
		this.agregarEmpresas=function(contenedor,elementos){
			var html="";
			for(var x=0;x<elementos.length;x++){
				html+="<article empresa>"+elementos[x].nombre+"</article>";
			}
			html+='<article add="empresa"></article>';
			contenedor.innerHTML=html;
			this.agregarFuncionamiento();
		};
		this.agregarEmpresa = function(empresa,contenedor){
			var nodo=document.createElement('article');
			nodo.textContent = empresa.nombre;
			nodo.setAttribute('empresa','');
			contenedor.insertBefore(nodo,contenedor.lastChild);
			this.agregarFuncionamiento();
		};
		this.agregarFuncionamiento = function(){
			var nodo=this.nodo;
			var lista=nodo.getElementsByTagName('article');
			for(var x=0;x<lista.length;x++){
				lista[x].style.cursor='pointer';
				if(lista[x].getAttribute('update')!==null){
					lista[x].onclick=this.edicion;
				}else if(lista[x].getAttribute('empresa')!==null){
					lista[x].onclick=function(){
						var registro = torque.buscarRegistro(interfaz.elementos.formulario.ventanaForm.registroId,torque.entidadActiva);
						var dataTemp = {
							cabecera:'Operaciones Por Empresa',
							cuerpo:'<label>'+this.textContent+'</label>',
							pie:'<section modalButtons>\
									<button type="button" cancelar id="modalButtonCancelar"></button>\
									<button type="button" modificar  id="modalButtonModificar"></button>\
									<button type="button" eliminar  id="modalButtonEliminar"></button>\
								</section>'
						}
						interfaz.elementos.modalWindow=new modalWindow();
						interfaz.elementos.modalWindow.arranque(dataTemp);
						var btnCancelar = document.getElementById("modalButtonCancelar");
						var btnModificar= document.getElementById("modalButtonModificar");
						var btnEliminar = document.getElementById("modalButtonEliminar");

						btnCancelar.onclick= function(){
							interfaz.elementos.modalWindow.elimiarUltimaCapa();
						}
					}
				}else if(lista[x].getAttribute('add')!==null){
					lista[x].onclick=function(){
						console.log('agregar');
						var registro = torque.buscarRegistro(interfaz.elementos.formulario.ventanaForm.registroId,torque.entidadActiva);
						var dataTemp = {
							cabecera:'Asignar Empresa',
							cuerpo:'<label>'+registro.nombre+'</label>\
									<select name="listaEmpresas" id="listaEmpresas">\
										<option value="-">Selecione un Valor</option>\
										<option value="1">SocaServicios</option>\
										<option value="2">SocaPortuguesa</option>\
										<option value="3">Probioagro</option>\
										<option value="4">E/S Piedritas Blancas</option>\
									</select>',
							pie:'<section modalButtons>\
									<button type="button" cancelar id="modalButtonCancelar"></button>\
									<button type="button" aceptar  id="modalButtonAceptar"></button>\
								</section>'
						}
						interfaz.elementos.modalWindow=new modalWindow();
						interfaz.elementos.modalWindow.arranque(dataTemp);
						//armo la lista de valores no permitidos
						var empresas=torque.buscarDetalle(interfaz.elementos.formulario.ventanaForm.registroId,'rol');
						var valoresNoPermitidos= Array();
						for(var x=0;x<empresas.length;x++){
							valoresNoPermitidos.push(empresas[x].id);
						}
						interfaz.elementos.formulario.validarCombo(valoresNoPermitidos,document.getElementById('listaEmpresas'));
						//agrego funcionamiento a los botones
						var btnCancelar = document.getElementById("modalButtonCancelar");
						var btnAceptar 	= document.getElementById("modalButtonAceptar");
						
						btnCancelar.onclick=function(){
							interfaz.elementos.modalWindow.elimiarUltimaCapa();
						}

						btnAceptar.onclick=function(){
							var lista = document.getElementById('listaEmpresas');
							//guardo el empresa
							if(lista.value!='-'){
								if(lista.value!='cerrar'){
									var empresa= {	
										id: lista.value,
										nombre: lista.options[lista.selectedIndex].textContent
									}
									var cambios = Array();
									cambios.push(empresa);
									torque.guardarEnDetalle(interfaz.elementos.formulario.ventanaForm.registroId,cambios);
									
									interfaz.elementos.formulario.ventanaForm.agregarEmpresa(empresa,document.getElementById('contenedorPri'));
									//cierrocapa
									interfaz.elementos.modalWindow.elimiarUltimaCapa();
								}else{
									interfaz.elementos.modalWindow.elimiarUltimaCapa()
								}
								
							}else{
								document.getElementById('listaEmpresas').options[document.getElementById('listaEmpresas').selectedIndex].textContent='Debe Elegir un Valor para Continuar';
							}
							
						}
					}
				}
			}
		};
		this.edicion=function(){
			var nodo=this;
			var campo=this.previousSibling;
			var campoEdicion=campo.previousSibling;
			var contenedor=nodo.parentNode;
			
			contenedor.style.maxHeight='1000px';

			campoEdicion.value=campo.textContent;
			campoEdicion.style.display='inline-block';

			campo.style.width=window.getComputedStyle(campo,null).getPropertyValue("width");
			campo.style.maxHeight=window.getComputedStyle(campo,null).getPropertyValue("height");
			nodo.classList.toggle('edicion');

			setTimeout(function(){
				campo.style.width='0px';
				campo.style.opacity='0';

				campoEdicion.style.width='calc(100% - 62px)';
				campoEdicion.style.padding='5px';
				campoEdicion.style.opacity='1';
				if(nodo.getAttribute('update')=='campo'){
					campoEdicion.style.height="20px";
				}else if(nodo.getAttribute('update')=='area'){
					campoEdicion.style.height="40px";
				}
			},10);
			setTimeout(function(){
				nodo.onclick=interfaz.elementos.formulario.ventanaForm.finEdicion;
				if(nodo.getAttribute('update')=='area'){
					campoEdicion.style.height="150px";
					campoEdicion.style.padding="15px";
				}
			},520);
			setTimeout(function(){
				campoEdicion.focus();
			},1010);

		};
		this.finEdicion = function(){
			var nodo=this;
			var campo=this.previousSibling;
			var campoEdicion=campo.previousSibling;
			var contenedor=nodo.parentNode;

			contenedor.style.maxHeight='150px';

			var id=interfaz.elementos.formulario.ventanaForm.registroId;
			var nombreCampo=campoEdicion.name;
			var valorCampo=campoEdicion.value;

			console.log('se disparo una edicion con id:'+interfaz.elementos.formulario.ventanaForm.registroId+' en campo:'+campoEdicion.name);
			var registro=torque.editarCampo(id,nombreCampo,valorCampo);
			interfaz.elementos.formulario.actualizarLista(registro);

			campo.textContent=campoEdicion.value;
			
			nodo.classList.toggle('edicion');
			campo.style.width='calc(100% - 62px)';
			campo.style.opacity='1';

			campoEdicion.style.width='0px';
			campoEdicion.style.opacity='0';
			campoEdicion.style.height='0px';
			setTimeout(function(){
				campoEdicion.style.width='auto';
				campoEdicion.style.display='none';
				nodo.onclick=interfaz.elementos.formulario.ventanaForm.edicion;
				campoEdicion.style.width=window.getComputedStyle(campoEdicion,null).getPropertyValue("width");
				campo.style.width=campoEdicion.style.width;
				campoEdicion.style.width='0px';
				campoEdicion.value='';
			},510)
		};	
	}
	/*------------------------------Objeto VentanaForm------------*/

</script>
<script type="text/javascript">
	
	var torque = new Motor('rol');
	//Inicialiazion de formulario
	var interfaz = new Arquitecto();
	var botones = ['buscar','nuevo','abrir'];
	var empresas = torque.buscarRegistros('empresa');
	interfaz.configure();
	interfaz.elementos.botonera = new Botonera(botones);
	interfaz.elementos.formulario = new Formulario();
	interfaz.elementos.formulario.cargarRegistros(torque.registrosEntAct);
	//boton buscar
	interfaz.elementos.botonera.buscarBoton('nuevo').nodo.onclick=function(){
		console.log('presiono Nuevo');
		var data = {
			tipo:'nuevo'
		}
		var formulario = interfaz.elementos.formulario;
		formulario.construirInterfaz(data);
	}
	//boton nuevo
	interfaz.elementos.botonera.buscarBoton('buscar').nodo.onclick=function(){
		console.log('presiono Buscar');
		interfaz.elementos.formulario.nodo.firstChild.getElementsByTagName('input')[0].focus();
	}

	//funcionamiento exclusivo del formulario
	function guardar(){
		var formulario = document.formNuevo;
		var data = new Array();
		var elemento;
		var validacion=false;
		for(var x=0;x<formulario.elements.length;x++){
			if(formulario.elements[x].type='text'){
				if(formulario.elements[x].value==''){
					validacion=true;
				}
				elemento = {nombre:formulario.elements[x].name,valor:formulario.elements[x].value};
				data.push(elemento);
			}
		}
		if(!validacion){
			var nuevoRegistro = {
				nombre : data[0].valor,
				id : contId++,
				descripcion : data[1].valor,
				detalle : []
			}
			torque.guardar(nuevoRegistro,'rol');
			var nuevoSlot=interfaz.elementos.formulario.agregarSlot(nuevoRegistro);
			nuevoSlot.firstChild.click();
		}else{
			console.log('formulario no paso la validacion');
		}
	}
</script>
</html>